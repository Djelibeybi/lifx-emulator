name: CI

on:
  push:
    branches:
    - main
  pull_request:

env:
  PYTHON_VERSION: '3.14'
  UV_VERSION: 0.9.9

jobs:
  # Code quality checks
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: uv sync --frozen

    - name: Run Ruff format check
      run: uv run ruff format --check .

    - name: Run Ruff linter (with complexity checks)
      run: uv run ruff check .

    - name: Run Pyright type checker
      run: uv run pyright

    - name: Check for security issues
      run: |
        uv pip install bandit
        uv run bandit -r packages/lifx-emulator-core/src/ packages/lifx-emulator/src/

  # Testing matrix across Python versions and platforms
  test:
    name: Test Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ matrix.python-version }}
        enable-cache: true

    - name: Install dependencies
      run: uv sync --frozen

    - name: Run unit tests with coverage threshold
      run: uv run --frozen pytest --cov-fail-under=80

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
      with:
        slug: Djelibeybi/lifx-emulator
        token: ${{ secrets.CODECOV_TOKEN }}
        fail_ci_if_error: false

    - name: Upload test results to Codecov
      if: ${{ !cancelled() }}
      uses: codecov/test-results-action@47f89e9acb64b76debcd5ea40642d25a4adced9f # v1
      with:
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  release:
    needs:
    - quality
    - test
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: write

    concurrency:
      group: ${{ github.workflow }}-release-${{ github.ref_name }}
      cancel-in-progress: false

    outputs:
      release-lifx-emulator-core: ${{ steps.release-lifx-emulator-core.outputs.release-lifx-emulator-core || 'false' }}
      release-lifx-emulator: ${{ steps.release-lifx-emulator.outputs.release-lifx-emulator || 'false' }}

    steps:
    - name: Checkout repository on release branch
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        ref: ${{ github.head_ref || github.ref_name }}
        fetch-depth: 0
        ssh-key: ${{ secrets.DEPLOY_KEY }}

    - name: Set up Python
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@ed21f2f24f8dd64503750218de024bcf64c7250a # v7
      with:
        version: ${{ env.UV_VERSION }}
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Configure git
      run: |
        git config --local user.email "github-actions@github.com"
        git config --local user.name "GitHub Actions"

    - name: Check Python Semantic Release for lifx-emulator-core
      id: check-release-lifx-emulator-core
      if: github.ref_name != 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd packages/lifx-emulator-core/
        uv run --with python-semantic-release semantic-release --noop version

    - name: Check Python Semantic Release for lifx-emulator
      id: check-release-lifx-emulator
      if: github.ref_name != 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd packages/lifx-emulator/
        uv run --with python-semantic-release semantic-release --noop version

    - name: Release lifx-emulator-core
      id: release-lifx-emulator-core
      if: github.ref_name == 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd packages/lifx-emulator-core/

        # Capture output to detect if a release was made
        output=$(uv run --with python-semantic-release semantic-release version 2>&1)
        echo "$output"

        # Check if a release was made (no "No release will be made" message)
        if echo "$output" | grep -q "No release will be made"; then
          echo "release-lifx-emulator-core=false" >> $GITHUB_OUTPUT
        else
          # Publish distribution artifacts to release
          uv run --with python-semantic-release semantic-release publish
          echo "release-lifx-emulator-core=true" >> $GITHUB_OUTPUT
        fi


    - name: Release lifx-emulator
      id: release-lifx-emulator
      if: github.ref_name == 'main'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd packages/lifx-emulator/

        # Capture output to detect if a release was made
        output=$(uv run --with python-semantic-release semantic-release version 2>&1)
        echo "$output"

        # Check if a release was made (no "No release will be made" message)
        if echo "$output" | grep -q "No release will be made"; then
          echo "release-lifx-emulator=false" >> $GITHUB_OUTPUT
        else
          # Publish distribution artifacts to release
          uv run --with python-semantic-release semantic-release publish
          echo "release-lifx-emulator=true" >> $GITHUB_OUTPUT
        fi

    - name: Upload Core Library Artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
      with:
        name: lifx-emulator-core-artifacts
        path: packages/lifx-emulator-core/dist

    - name: Upload CLI Package Artifacts
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
      with:
        name: lifx-emulator-artifacts
        path: packages/lifx-emulator/dist


  deploy-core:
    name: Deploy Core Library to PyPI
    runs-on: ubuntu-latest
    needs: release
    if: ${{ needs.release.outputs.release-lifx-emulator-core == 'true' }}

    permissions:
      contents: read
      id-token: write

    environment:
      name: pypi
      url: https://pypi.org/p/lifx-emulator-core

    steps:
    - name: Download Core Library Artifacts
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
      with:
        name: lifx-emulator-core-artifacts
        path: dist

    - name: Publish lifx-emulator-core to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist
        print-hash: true
        verbose: true

  deploy-cli:
    name: Deploy CLI Package to PyPI
    runs-on: ubuntu-latest
    needs:
    - release
    - deploy-core  # CLI depends on core being published first
    if: ${{ needs.release.outputs.release-lifx-emulator == 'true' }}

    permissions:
      contents: read
      id-token: write

    environment:
      name: pypi
      url: https://pypi.org/p/lifx-emulator

    steps:
    - name: Download CLI Package Artifacts
      uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
      with:
        name: lifx-emulator-artifacts
        path: dist

    - name: Publish lifx-emulator to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: dist
        print-hash: true
        verbose: true
